name: Compare des Grist
run-name: Génère un rapport de différence entre 2 documents Grist
permissions: {}

on:
  workflow_dispatch: # Pour activer le déclenchement manuel
    inputs:
      cible:
        description: 'Cible'
        required: true
        type: choice
        options:
          - guides

jobs:
  genere-tableau-comparatif:
    name: Comparaison ${{ inputs.cible }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        cible: ['${{ inputs.cible }}']
    steps:
      - name: Cloner le dépôt Git
        uses: actions/checkout@v4

      - name: Configurer Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'

      - name: Installe pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.24.0

      - name: (TOUS) Installe les dépendances
        run: pnpm install --frozen-lockfile

      - name: Lance le script de comparaison
        run: pnpm -F comparaison-grist start:${{ matrix.cible }}:compare
        env:
          GUIDES_SOURCE_GRIST_URL: ${{ secrets.GUIDES_SOURCE_GRIST_URL }}
          GUIDES_SOURCE_GRIST_ID_TABLE: ${{ secrets.GUIDES_SOURCE_GRIST_ID_TABLE }}
          GUIDES_SOURCE_GRIST_API_KEY: ${{ secrets.GUIDES_SOURCE_GRIST_API_KEY }}
          GUIDES_CIBLE_GRIST_URL: ${{ secrets.GUIDES_CIBLE_GRIST_URL }}
          GUIDES_CIBLE_GRIST_ID_TABLE: ${{ secrets.GUIDES_CIBLE_GRIST_ID_TABLE }}
          GUIDES_CIBLE_GRIST_API_KEY: ${{ secrets.GUIDES_CIBLE_GRIST_API_KEY }}

      - name: Sauvegarde l'empreinte source
        uses: actions/upload-artifact@v4
        with:
          name: empreinte-data-${{ matrix.cible }}
          path: comparaison-grist/empreinte.txt

  publie-ressources-grist:
    name: Publie ${{ matrix.cible }}
    runs-on: ubuntu-latest
    needs: genere-tableau-comparatif
    # environment: PROD_NODE
    strategy:
      matrix:
        cible: ['${{ inputs.cible }}']
    steps:
      - name: Télécharger les empreintes sources
        uses: actions/download-artifact@v4
        with:
          name: empreinte-data-${{ matrix.cible }}

      - name: Affiche les empreintes sources
        run: cat empreinte.txt
